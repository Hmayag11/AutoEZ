**MATLAB Code Manual for**

**Machine Learning on Interictal Intracranial EEG Predicts Surgical Outcome in Drug Resistant Epilepsy**

Hmayag Partamian<sup>1,2</sup>, Saeed Jahromi<sup>1,2</sup>, Ludovica Corona<sup>1,2</sup>, M Scott Perry<sup>1</sup>, Eleonora Tamilia<sup>3,5</sup>, Joseph R. Madsen<sup>4</sup>, Jeffrey Bolton<sup>5</sup>, Scellig S.D. Stone<sup>4</sup>, Phillip L. Pearl<sup>5</sup>, Christos Papadelis<sup>1,2,6\*</sup>

**Table of Contents**

[**Folders** 1](#_Toc178680894)

[**Prerequisites** 2](#_Toc178680895)

[**Installation time** 3](#_Toc178680896)

[**Expected runtime** 3](#_Toc178680897)

[**Getting started** 3](#_Toc178680898)

[**Loading data** 3](#_Toc178680899)

[**Processing pipeline** 4](#_Toc178680900)

[**Output of the code** 5](#_Toc178680901)

[**Expected output** 5](#_Toc178680902)

[**Good-outcome patient 1** 5](#_Toc178680903)

[**Temporal maps** 5](#_Toc178680904)

[**Epileptogenic and background networks in the band** 6](#_Toc178680905)

[**Properties of networks in the band** 6](#_Toc178680906)

[**Poor-outcome patient 31** 7](#_Toc178680907)

[**Temporal Maps** 7](#_Toc178680908)

[**Epileptogenic and background networks in the band** 8](#_Toc178680909)

[**Properties of networks in the band** 8](#_Toc178680910)

[**Running the framework on your own data** 9](#_Toc178680911)

[**References** 9](#_Toc178680912)

# **Folders**

**anatomy**

CT_P1.nii

CT_P31.nii

MRI_P1.nii

MRI_P31.nii

**figures**

background_network_P1.png

background_network_P31.png

epileptogenic_network_P1.png

epileptogenic_network_P31.png

temporal_map_P1.png

temporal_map_P31.png

properties_P1.png

properties_P31.png

**functions**

checkDICOM.m

distiance_electrodes_to_resection.m

DMDfull.m

Extract_networks_and_temporal_maps.m

extractFeatures.m

getIndices.m

**sample_data**

sample_data_P1.mat

sample_data_P31.mat

MRI_P1.fig

MRI_P31.fig

demo_run_P1.m

demo_run_P31.m

LICENSE

README.md

# **Prerequisites**

MATLAB (we applied the framework with MATLAB R2019a and 2024a)

• The following MATLAB add-ons need to be installed:

– ‘Signal Processing Toolbox’

– ‘Statistics and Machine Learning Toolbox’

– ‘Image Processing Toolbox’

• Brainstorm <sup>2</sup> (only for preprocessing the MRI and CT-scans and visualization purposes)

• DMD code ‘DMDfull.m’ <sup>1</sup>, (<http://dmdbook.com/>)

• Windows, macOS, or Linux operating system

# **Installation time**

None. Simple unzipping and preparation of the script (fixing paths and preparing your data in the format specified).

# **Expected runtime**

The experiments were performed on a Dell desktop with 12th Gen Intel(R) Core (TM) i9-12900 2.40 GHz with 128 GB RAM, and 64-bit operating system (x64-based processor) Windows 10.

To process 50-second iEEG with 80-120 channels, with sampling frequency of 1999 Hz, using 95% overlap, and using MATLAB 2024a, the expected overall running time is around 50-90 seconds.

# **Getting started**

After running MATLAB and downloading and unzipping the code folder, set the current workspace to the repository folder, adjust the paths in the scripts to their corresponding paths, and run the demo_run_P1.m (Good outcome patient) or demo_run_P13.m (Poor Outcome Patient)

demo_run_P1.m

demo_run_P13.m

The demo scripts will automatically perform the following:

- Read and preprocess the data, extract the features and the networks, and identify the epileptogenic and background networks.
- Generate the temporal maps with a sample data with annotations in both the spike and ripple bands.
- Compute the network properties and evaluate the AUC with resection, SOZ, and temporal map concordance with IED.

**Note:** To plot the networks, we provided 3D figures for each of the two patients generated by Brainstorm. The figures might not load if Brainstorm is not installed. Since the function hold on doesn’t function directly on such figures, the user must click anywhere inside the figure first and then run the next script to plot the network over these 3D figures (we noted the locations in the script where this step should be done with the current data). When the user generates the 3D plots directly from Brainstorm (when used with fully processed data), this problem is not encountered.

# **Loading data**

The demo scripts will use the data of two patients sampled from our cohort. P1 was seizure free (good outcome) and P31 had recurring seizures (poor outcome).

sample_data_P1.mat

sample_data_P31.mat

When these MATLAB files are loaded, they contain the following matrices:

- Fs : sampling frequency.
- iEEG : 50 second n-channel iEEG data.
- time : time in seconds.
- channel_coordinates : containing the coordinates of the implanted n electrodes.
- soz_channels : contains a vector of size n with 0’s (non-SOZ) and 1’s (SOZ).
- resection_coordinates : contains the coordinates of the resection volume.
- spike_annotation : contains the annotations of spikes in time.
- ripple_annotation : contains the annotations of ripples in time.
- CustomColormap : a custom colormap used to set the desired network colors (red for epileptogenic and blue for background).

**Note:** We provided in the anatomy folder the MRI and implantation CT in NIfTI in case the user wants to process the data from scratch. We used these files to coregister the CT and MRI and generate the channel coordinates of the provided data. The 3D views of the MRIs in Brainstorm were used in generated figures.

# **Processing pipeline**

The code runs by calling different functions listed in the function folder:

1. The data is first filtered in the spike band \[1-80 Hz\] using 4<sup>th</sup> order Butterworth filter (MATLAB)
2. After setting the percentage overlap, number of modes, and window size parameter “offset”, the extractFeatures function dissects the data into windows, applies the DMD, and outputs the DMD spectral power features, the mean frequency of modes across windows, and the spike labels of each window.
3. The mean frequencies are processed using getIndices function to identify indices of the modes that fall within each of the six band for the spike band analysis.
4. Extract_networks_and_temporal_maps function takes the indices and the DMD spectral powers across windows to find the dominantly reoccurring spatial configurations and their corresponding activity across windows. The function also identifies the epileptogenic and background networks and outputs the indices of the temporal maps.
5. Steps 1-4 are repeated in the ripple band \[80-250\] and ripple annotations to extract the epileptogenic and background networks and their temporal maps in the ripple band.
6. The temporal maps and networks can now be visualized via plots.
7. The network properties (Focality, overlap with resolution, and distance from resection) are computed.
8. AUC with SOZ, resection, and ripple and spike annotations are then computed to generate the properties plots.

# **Output of the code**

The code outputs:

- The time series data, the annotations (spikes and ripples), and the temporal maps in the spike and the ripple bands
- The networks projected on the MRI as well as the resection volumes.
- The network properties (focality, overlap with resection, and distance from resection), and receiver operating curve area under the curve (AUC) with the seizure onset zone (SOZ), resection (RES), and the AUC of the active time-windows with the annotated timestamps of the IEDs and ripples.
- Frequency bands: Frequency bands: delta 1-4 Hz), theta (4-8 Hz), alpha (= 8-12 Hz), beta (=12-30 Hz), gamma (= 30-80 Hz), spike band (= 1-80 Hz), ripple band (= 80-250 Hz).

# **Expected output**

After running the scripts, the following figures will be generated. Users can change the parameter bd_current to the corresponding band by using the following number code (=1, =2,=3,=4, =5, =6, =7). Here, the networks and the properties are those of the band (bd_current=2).

## **Good-outcome patient 1**

The following results are expected when running demo_run_P1.m.

### **Temporal maps**

<p align="center">
  <img width="45%" src="figures/emporalMap50sec_P1.png"/>
</p> 

**Figure 1**. **Temporal maps in the spike and ripple bands of good outcome patient 1.** Sample iEEG (50 s) in the spike band with spike annotations (red vertical lines) and its corresponding temporal maps generated using our framework. Sample iEEG (50 s) in the ripple band with ripple annotations (red vertical lines) and its corresponding temporal maps generated from the framework. Red timestamps in the temporal map are time-windows where the epileptogenic network is active while the blue timestamps represent the time-windows where the background network is active.

### **Epileptogenic and background networks in the band**

| --- | --- |

**Figure 2**. **Epileptogenic and background networks of good outcome patient 1.** The epileptogenic (red) and background (blue) networks generated by the framework are projected onto the MRI and overlapped with the resection volume (green).

### **Properties of networks in the band**

**![A group of red and blue bars


**Figure 3**. **Epileptogenic and background network properties in the band and predictive power of good outcome patient 1.** The focality, overlap with resection, and distance from resection, AUC with resection, AUC with SOZ, and the AUC of the temporal map with IED of the epileptogenic (red) and background (blue) networks.

## **Poor-outcome patient 31**

The following results are expected when running demo_run_P31.m.

### **Temporal Maps**

**![A close-up of a barcode


**Figure 4**. **Temporal maps in spike and ripple bands of poor outcome patient 31.** Sample iEEG (50 s) in the spike band with spike annotations (red vertical lines) and its corresponding temporal maps generated from the framework. Sample iEEG (50 s) in the ripple band with ripple annotations (red vertical lines) and its corresponding temporal maps generated from the framework. Red timestamps in the temporal map are the time-windows where the epileptogenic network is active while the blue timestamps represent the time-windows where the background network is active.

### **Epileptogenic and background networks in the band**

| --- | --- |

**Figure 5**. **Epileptogenic and background networks in the band of poor outcome patient 31.** The epileptogenic (red) and background (blue) networks generated by the framework are projected onto the MRI and overlapped with the resection volume (green).

### **Properties of networks in the band**



**Figure 6 Epileptogenic and background network properties in the band and predictive power of poor outcome patient 31.** The focality, overlap with resection, and distance from resection, AUC with resection, AUC with SOZ, and the AUC of the temporal map with IED of the epileptogenic (red) and background (blue) networks in the band.

# **Running the framework on your own data**

To run the framework on your own data, consider following the following steps:

1. Extract clean artifact-free iEEG data segments.
2. Preprocess the data with a notch filter.
3. Remove bad channels.
4. Save the data as ieeg.mat file.
5. Make sure to specify the Fs and time.
6. Extract channel coordinates by coregistration of post-implantation MRI with CT. Add the resection volume coordinates if available for the AUCRE computations and the properties of networks.
7. Make sure the following are available in your workspace:

- Fs : sampling frequency of your data
- ieeg: segment of iEEG data.
- time : time in seconds.
- channel_coordinates : containing the coordinates of the implanted electrodes.
- soz_channels : contains a vector of 0’s (non-SOZ) and 1’s (SOZ).
- resection_coordinates : contains the coordinates of the resection volume.
- spike_annotation : contains the annotations of spikes in time.
- ripple_annotation : contains the annotations of ripples in time.
- CustomColormap : a custom colormap used to set the desired network colors (red for epileptogenic and blue for background). Use the one provided with our data.

1. Update the demo code and run.
2. To plot the networks, you may need to generate the 3D view of the of the provided NIfTI anatomy files, coregister the CT on a software like Brainstorm and overlay the networks.

# **References**

1\. Kutz, J. N., Brunton, S. L., Brunton, B. W. & Proctor, J. L. _Dynamic Mode Decomposition_. (Society for Industrial and Applied Mathematics, Philadelphia, PA, 2016). doi:10.1137/1.9781611974508.

2\. Tadel, F., Baillet, S., Mosher, J. C., Pantazis, D. & Leahy, R. M. Brainstorm: A User-Friendly Application for MEG/EEG Analysis. _Computational Intelligence and Neuroscience_ **2011**, 879716 (2011).